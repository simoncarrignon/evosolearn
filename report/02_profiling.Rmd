# Exploring code speed


## How execution time scales

### Carrying capacity
```{r,echo=F}
doit=FALSE
```
```{r,eval=!doit}
load("data/allstr.bin")
load("data/allstr_tstep.bin")
```


Testing how execution time  change  when K increase when no social learn vs random selection vs best selection:
General parameters:
```{r}
strategies=c("best","random")
names(strategies)=strategies
colsstrategies=c("red","blue")
names(colsstrategies)=strategies
Ks=c(100,500,1000,2000,5000,10000)
tstep=5000
n=300
o=0 #omega
d=1 #delta
m=c(x=.1,y=.1,z=.1)
mu=c(x=.001,y=0.001,z=0.001)
E=c(x=0,y=0,z=0)
sigma=c(s=1000,y=10,z=10)
tsteps=c(100,1000,5000,10000)
```

```{r,eval=doit}
library(microbenchmark)
pop=generatePop(n,distrib=list(x=runif(n,-1,1),y=runif(n),z=runif(n)),df=F)

allstr=lapply( strategies,function(strat)
              {
                  timings=lapply(Ks,function(k)
								 {
									 print(k)
									 microbenchmark(
													simpleEvoModel(
																   n=n,
																   tstep=tstep,
																   omega = o,
																   delta = d ,
																   b=2,
																   K=k,
																   m=m,
																   mu=mu,
																   E=E,
																   sigma=sigma,
																   sls=strat,
																   pop=pop,
																   outputrate=1000,log=T
																   ),
													times=5,
													unit="s")
									 
								 })
                  print(strat)
                  sapply(timings,function(i)mean(i[,"time"]))
              }
)

#save(file="data/allstr.bin",allstr)
```


```{r profileKs,fig.cap="Executation time for differente carrying capacities"}
plot(Ks,allstr$best/10000000000,col="red",type="l",ylab="Execution time (in second)",xlab="K")
lines(Ks,allstr$random/10000000000,col="blue",type="l")
legend("topleft",legend=strategies,lty=1,col=colsstrategies)
```

### Number of time step 

Looking at the nubmer of timestep:

```{r,eval=doit}
k=1000

pop=generatePop(n,distrib=list(x=runif(n,-1,1),y=runif(n),z=runif(n)),df=F)

allstr_tstep=lapply( strategies,function(strat)
              {
                  timings=lapply(tsteps,function(tstep)
                                 microbenchmark(
                                                simpleEvoModel(
                                                               n=n,
                                                               tstep=tstep,
                                                               omega = o,
                                                               delta = d ,
                                                               b=2,
                                                               K=k,
                                                               m=m,
                                                               mu=mu,
                                                               E=E,
                                                               sigma=sigma,
                                                               sls=strat,
                                                               pop=pop,
                                                               outputrate=1,log=F
                                                               ),
                                                times=5,
                                                unit="s")
                                 )
                  print(strat)
                  sapply(timings,function(i)mean(i[,"time"]))
              }
)
#save(file="data/allstr_tstep.bin",allstr_tstep)
```

```{r profileTstep,fig.cap="Executation time for different number of tstep"}
plot(tsteps,allstr_tstep$best/10000000000,col="red",type="l",ylab="Execution time (in second)",xlab="time step")
lines(tsteps,allstr_tstep$random/10000000000,col="blue",type="l")
legend("topleft",legend=strategies,lty=1,col=colsstrategies)
```

## Profiling function calls

Profiling the model using `Rprof`:


```{r}
n=1000
pop=generatePop(n,distrib=list(x=runif(n,-1,1),y=rep(0,n),z=rep(0,n)),df=F)
tstep=1000
theta=environment(tstep,omega,.1,0)

par(mfrow=c(2,1))
for(strat in strategies){
df <- "test.log"
Rprof(df, memory.profiling = TRUE)
evodf=simpleEvoModel(n,tstep,omega = 0,delta = 0 ,b=2,K=1000,m=,mu=mu,E=E,sigma=sigma,log=F,sls=strat,theta=theta,pop=pop)
plot(evodf[,"mean_x"],type="l",ylab="mean_x",main=paste("strategie:",strat))
plot(evodf[,"mean_y"],type="l",col="green",ylim=c(0,1))
lines(evodf[,"mean_z"],type="l",col="orange")
legend("topleft",legend=c("mean_y","mean_z"),lty=1,col=c("green","orange"))
Rprof(NULL) ; 
sdf=summaryRprof(df)
rmarkdown::paged_table(as.data.frame(evodf))
}
```
